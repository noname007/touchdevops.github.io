<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="Cloud &amp; DevOps" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>OpenStack - Cloud &amp; DevOps</title><link rel="stylesheet" href="/css/main.css" type="text/css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Cloud &amp; DevOps</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><span class="post__time">墨鱼</span><span class="post__time"> @ </span><time datetime="2015-02-11T01:56:56.000Z" class="post__time">February 11, 2015</time><h1 class="post__title"><a href="/2015/02/11/openstack-novnc/">openstack novnc实现</a></h1></header><div class="post__main echo"><h2 id="概述">概述</h2>
<p>对于使用过OpenStack的用户，我们第一次操作虚拟机都可能是直接通过OpenStack Dashbord管理控制台提供的Web vnc来进行使用。</p>
<p>如图所示，我们可以很方便的使用该功能，对虚拟机进行管理和配置；</p>
<a id="more"></a>
<p><img src="http://filehost.qiniudn.com/dashbord_console.png" alt=""></p>
<h2 id="OpenStack虚拟化">OpenStack虚拟化</h2>
<p>对于OpenStack而言，OpenStack并不直接提供虚拟化技术实现，而是直接使用现虚拟化技术如QEMU，KVM，XenServer等。</p>
<p>对于KVM和QEMU我们可以通过如下命令在操作系统上运行一台虚拟机。</p>
<p>以在Linux上直接使用kvm创建windows虚拟机为例</p>
<p>定义虚拟机Disk</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qemu-img create <span class="operator">-f</span> qcow windows7.qcow2 <span class="number">20</span>G</div></pre></td></tr></table></figure>

<p>使用kvm导入ISO镜像，并且安装操作系统</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kvm -m <span class="number">2048</span> -no-reboot -boot <span class="variable">order=</span>d -drive <span class="variable">file=</span>windows7.qcow2,<span class="variable">if=</span>virtio,<span class="variable">boot=</span>off -drive <span class="variable">file=</span>windows7.iso,<span class="variable">media=</span>cdrom,<span class="variable">boot=</span>on -drive <span class="variable">file=</span>virtio-win-<span class="number">0.1</span>-<span class="number">94</span>.iso,<span class="variable">media=</span>cdrom,<span class="variable">boot=</span>off -net nic,<span class="variable">model=</span>virtio -nographic -vnc :<span class="number">1</span></div></pre></td></tr></table></figure>

<p>此时我们指定了虚拟机的模式为-nographic 并且指定了vnc端口，这个时我们就可以通过localhost:1访问到该虚拟机</p>
<p>而对OpenStack而言，OpenStak更多是作为上层的管理者负责管理和控制地城的虚拟化技术</p>
<p>当我们使用nova命令创建一台虚拟机之后</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">nova list</div><div class="line"></div><div class="line"><span class="code">+--------------------------------------+</span>---------------------<span class="code">+--------+</span>------------<span class="code">+-------------+</span>---------------------------------------------+</div><div class="line"><span class="header">| ID                                   | Name                | Status | Task State | Power State | Networks                                    |</span></div><div class="line">+--------------------------------------+---------------------+--------+------------+-------------+---------------------------------------------+</div><div class="line"><span class="header">| c75adb4f-c554-4fa2-962e-35fef3367041 | centos-test         | ACTIVE | -          | Running     | internal-network=192.168.0.50, 10.74.149.23 |</span></div><div class="line">+--------------------------------------+---------------------+--------+------------+-------------+---------------------------------------------+</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">nova show c75adb4f-c554-<span class="number">4</span>fa2-<span class="number">962</span>e-<span class="number">35</span>fef3367041</div><div class="line"></div><div class="line">+--------------------------------------+-------------------------------------------------------------+</div><div class="line"><span class="string">| Property                             | Value                                                       |</span></div><div class="line">+--------------------------------------+-------------------------------------------------------------+</div><div class="line"><span class="string">| OS-DCF:diskConfig                    | AUTO                                                        |</span></div><div class="line"><span class="string">| OS-EXT-AZ:availability_zone          | hp-server                                                   |</span></div><div class="line"><span class="string">| OS-EXT-SRV-ATTR:host                 | compute02                                                   |</span></div><div class="line"><span class="string">| OS-EXT-SRV-ATTR:hypervisor_hostname  | compute02                                                   |</span></div><div class="line"><span class="string">| OS-EXT-SRV-ATTR:instance_name        | instance-00000044                                           |</span></div><div class="line"><span class="string">| OS-EXT-STS:power_state               | 1                                                           |</span></div><div class="line"><span class="string">| OS-EXT-STS:task_state                | -                                                           |</span></div><div class="line"><span class="string">| OS-EXT-STS:vm_state                  | active                                                      |</span></div><div class="line"><span class="string">| OS-SRV-USG:launched_at               | 2015-02-06T06:03:24.000000                                  |</span></div><div class="line"><span class="string">| OS-SRV-USG:terminated_at             | -                                                           |</span></div><div class="line"><span class="string">| accessIPv4                           |                                                             |</span></div><div class="line"><span class="string">| accessIPv6                           |                                                             |</span></div><div class="line"><span class="string">| config_drive                         |                                                             |</span></div><div class="line"><span class="string">| created                              | 2015-02-06T06:02:37Z                                        |</span></div><div class="line"><span class="string">| flavor                               | m1.small (2)                                                |</span></div><div class="line"><span class="string">| hostId                               | dddad0cc7fcd1cad5eeb87ea7bad2a9f31d690d8955d73b998e2ba5c    |</span></div><div class="line"><span class="string">| id                                   | c75adb4f-c554-4fa2-962e-35fef3367041                        |</span></div><div class="line"><span class="string">| image                                | centOS_6.5_x86_64_en (d923120e-5a1f-417f-b627-36320215f8be) |</span></div><div class="line"><span class="string">| internal-network network             | 192.168.0.50, 10.74.149.23                                  |</span></div><div class="line"><span class="string">| key_name                             | -                                                           |</span></div><div class="line"><span class="string">| metadata                             | {}                                                          |</span></div><div class="line">  <span class="string">| name                                 | centos-test                                                 |</span></div><div class="line">  <span class="string">| os-extended-volumes:volumes_attached | []                                                          |</span></div><div class="line">  <span class="string">| progress                             | 0                                                           |</span></div><div class="line">  <span class="string">| security_groups                      | default                                                     |</span></div><div class="line">  <span class="string">| status                               | ACTIVE                                                      |</span></div><div class="line">  <span class="string">| tenant_id                            | 52941cb7e81644c1a32fb087b83d83b6                            |</span></div><div class="line">  <span class="string">| updated                              | 2015-02-06T06:02:40Z                                        |</span></div><div class="line">  <span class="string">| user_id                              | 33aef1cf867d48468fc295ac46296953                            |</span></div><div class="line">  +--------------------------------------+-------------------------------------------------------------+</div></pre></td></tr></table></figure>

<p>同样OpenStack调用了libvirt接口利用底层虚拟化技术Provider创建了一台虚拟设备，我们可以在计算节点上查看qemu进程，如下所示，只是参数比起我们自己使用qemu会相对负责许多，因为涉及到诸如网络信息的配置等</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ps -ef|grep qemu</span></div><div class="line">libvirt+  <span class="number">2711</span>     <span class="number">1</span>  <span class="number">6</span> <span class="number">14</span>:<span class="number">01</span> ?        <span class="number">00</span>:<span class="number">01</span>:<span class="number">02</span> /usr/bin/qemu-system-x86_64 -name instance-<span class="number">00000043</span> -S -machine pc-i440fx-trusty,<span class="variable">accel=</span>kvm,<span class="variable">usb=</span>off -cpu Nehalem,+rdtscp,+dca,+pdcm,+xtpr,+tm2,+est,+vmx,+ds_cpl,+monitor,+dtes64,+pbe,+tm,+ht,+ss,+acpi,+ds,+vme -m <span class="number">512</span> -realtime <span class="variable">mlock=</span>off -smp <span class="number">1</span>,<span class="variable">sockets=</span><span class="number">1</span>,<span class="variable">cores=</span><span class="number">1</span>,<span class="variable">threads=</span><span class="number">1</span> -uuid e6759873-<span class="number">7</span>e62-<span class="number">4341</span>-<span class="number">9</span>a35-<span class="number">39</span>a10d65fb12 -smbios <span class="variable">type=</span><span class="number">1</span>,<span class="variable">manufacturer=</span>OpenStack Foundation,<span class="variable">product=</span>OpenStack Nova,<span class="variable">version=</span><span class="number">2014.1</span>.<span class="number">3</span>,<span class="variable">serial=</span><span class="number">35383339</span>-<span class="number">3134</span>-<span class="number">434</span>e-<span class="number">4731</span>-<span class="number">323353345756</span>,<span class="variable">uuid=</span>e6759873-<span class="number">7</span>e62-<span class="number">4341</span>-<span class="number">9</span>a35-<span class="number">39</span>a10d65fb12 -no-user-config -nodefaults -chardev socket,<span class="variable">id=</span>charmonitor,<span class="variable">path=</span>/var/lib/libvirt/qemu/instance-<span class="number">00000043</span>.monitor,server,nowait -mon <span class="variable">chardev=</span>charmonitor,<span class="variable">id=</span>monitor,<span class="variable">mode=</span>control -rtc <span class="variable">base=</span>utc,<span class="variable">driftfix=</span>slew -global kvm-pit.<span class="variable">lost_tick_policy=</span>discard -no-hpet -no-shutdown -boot <span class="variable">strict=</span>on -device piix3-usb-uhci,<span class="variable">id=</span>usb,<span class="variable">bus=</span>pci.<span class="number">0</span>,<span class="variable">addr=</span><span class="number">0</span>x1.<span class="number">0</span>x2 -drive <span class="variable">file=</span>/var/lib/nova/instances/e6759873-<span class="number">7</span>e62-<span class="number">4341</span>-<span class="number">9</span>a35-<span class="number">39</span>a10d65fb12/disk,<span class="variable">if=</span>none,<span class="variable">id=</span>drive-virtio-disk0,<span class="variable">format=</span>qcow2,<span class="variable">cache=</span>none -device virtio-blk-pci,<span class="variable">scsi=</span>off,<span class="variable">bus=</span>pci.<span class="number">0</span>,<span class="variable">addr=</span><span class="number">0</span>x4,<span class="variable">drive=</span>drive-virtio-disk0,<span class="variable">id=</span>virtio-disk0,<span class="variable">bootindex=</span><span class="number">1</span> -netdev tap,<span class="variable">fd=</span><span class="number">25</span>,<span class="variable">id=</span>hostnet0,<span class="variable">vhost=</span>on,<span class="variable">vhostfd=</span><span class="number">26</span> -device virtio-net-pci,<span class="variable">netdev=</span>hostnet0,<span class="variable">id=</span>net0,<span class="variable">mac=</span>fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">59</span>:<span class="number">90</span>:<span class="number">96</span>,<span class="variable">bus=</span>pci.<span class="number">0</span>,<span class="variable">addr=</span><span class="number">0</span>x3 -chardev file,<span class="variable">id=</span>charserial0,<span class="variable">path=</span>/var/lib/nova/instances/e6759873-<span class="number">7</span>e62-<span class="number">4341</span>-<span class="number">9</span>a35-<span class="number">39</span>a10d65fb12/console.log -device isa-serial,<span class="variable">chardev=</span>charserial0,<span class="variable">id=</span>serial0 -chardev pty,<span class="variable">id=</span>charserial1 -device isa-serial,<span class="variable">chardev=</span>charserial1,<span class="variable">id=</span>serial1 -device usb-tablet,<span class="variable">id=</span>input0 -vnc <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">1</span> -k en-us -device cirrus-vga,<span class="variable">id=</span>video0,<span class="variable">bus=</span>pci.<span class="number">0</span>,<span class="variable">addr=</span><span class="number">0</span>x2 -device virtio-balloon-pci,<span class="variable">id=</span>balloon0,<span class="variable">bus=</span>pci.<span class="number">0</span>,<span class="variable">addr=</span><span class="number">0</span>x5</div></pre></td></tr></table></figure>

<p>虚拟机的文件保存在/var/lib/nova/instances目录中。</p>
<p><img src="http://filehost.qiniudn.com/vnc_viewer.png" alt=""></p>
<p><img src="http://filehost.qiniudn.com/connect_to_vm.png" alt=""></p>
<h2 id="Nova_Console实现">Nova Console实现</h2>
<p>基于Libvirt对虚拟化技术的管控基础上，Nova项目提供了如下主要功能：</p>
<ul>
<li>API：提供外部访问Http访问接口</li>
<li>Compute Core：负责对虚拟化资源的生命周期管理</li>
<li>Networking for VMS：负责虚拟机的网络访问控制等及Nova-Network模式，适合小型的企业私有云，更多的场景还是考虑使用Neutron</li>
<li>Image management (EC2 scenario)：与Glance组件通讯负责镜像管理</li>
<li>Command-line clients and other interfaces： 提供命令行管理接口</li>
<li>Console interface：提供VNC以及NoVNC功能，方便管理和使用OpenStack虚拟机</li>
</ul>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/OpenStack/" class="post__tag__link">OpenStack</a></li></ul><a href="/2015/02/11/openstack-novnc/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2015 Cloud & DevOps小组</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><span title="Next" class="page-menu__link icon-arrow-right page-menu__link--disabled"></span></li></menu></footer></body></html>