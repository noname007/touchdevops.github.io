<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="Cloud &amp; DevOps" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Gradle中的buildScript代码块 - Cloud &amp; DevOps</title><link rel="stylesheet" href="/css/main.css" type="text/css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Cloud &amp; DevOps</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><span class="post__time">黄博文</span><span class="post__time"> @ </span><time datetime="2014-10-30T03:13:25.000Z" class="post__time">October 30, 2014</time><h1 class="post__title"><a href="/2014/10/30/build-script-in-gradle/">Gradle中的buildScript代码块</a></h1></header><div class="post__main echo"><p>在编写Gradle脚本的时候，在build.gradle文件中经常看到这样的代码：</p>
<a id="more"></a>
<figure class="highlight groovy"><figcaption><span>build.gradle</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="gradle"><span class="keyword">buildScript</span> {</span></div><div class="line">     <span class="keyword">repositories</span> {</div><div class="line">         mavenCentral()</div><div class="line">}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">repositories</span> {</div><div class="line">     mavenCentral()</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这样子很容易让人奇怪，为什么repositories要声明两次哪？buildscript代码块中的声明与下半部分声明有什么不同？</p>
<p>其实答案非常简单。buildscript中的声明是gradle脚本自身需要使用的资源。可以声明的资源包括依赖项、第三方插件、maven仓库地址等。而在build.gradle文件中直接声明的依赖项、仓库地址等信息是项目自身需要的资源。</p>
<p>gradle是由groovy语言编写的，支持groovy语法，可以灵活的使用已有的各种ant插件、基于jvm的类库，这也是它比maven、ant等构建脚本强大的原因。虽然gradle支持开箱即用，但是如果你想在脚本中使用一些第三方的插件、类库等，就需要自己手动添加对这些插件、类库的引用。而这些插件、类库又不是直接服务于项目的，而是支持其它build脚本的运行。所以你应当将这部分的引用放置在buildscript代码块中。gradle在执行脚本时，会优先执行buildscript代码块中的内容，然后才会执行剩余的build脚本。</p>
<p>举个例子，假设我们要编写一个task，用于解析csv文件并输出其内容。虽然我们可以使用gradle编写解析csv文件的代码，但其实apache有个库已经实现了一个解析csv文件的库供我们直接使用。我们如果想要使用这个库，需要在gradle.build文件中加入对该库的引用。</p>
<figure class="highlight groovy"><figcaption><span>build.gradle</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">buildscript</span> {</div><div class="line">    <span class="keyword">repositories</span> {</div><div class="line">        mavenLocal()</div><div class="line">        mavenCentral()</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">dependencies</span> {</div><div class="line">        <span class="keyword">classpath</span> <span class="string">'org.apache.commons:commons-csv:1.0'</span></div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.csv.*</div><div class="line"></div><div class="line"><span class="keyword">task</span> printCSV() {</div><div class="line">    <span class="keyword">doLast</span> {</div><div class="line">        <span class="keyword">def</span> records = CSVFormat.EXCEL.parse(<span class="keyword">new</span> FileReader(<span class="string">'config/sample.csv'</span>))</div><div class="line">        <span class="keyword">for</span> (item in records) {</div><div class="line">            <span class="keyword">print</span> item.get(<span class="number">0</span>) + <span class="string">' '</span></div><div class="line">            <span class="keyword">println</span> item.get(<span class="number">1</span>)</div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>buildscript代码块中的repositories和dependencies的使用方式与直接在build.gradle文件中的使用方式几乎完全一样。唯一不同之处是在buildscript代码块中你可以对dependencies使用classpath声明。该classpath声明说明了在执行其余的build脚本时，class loader可以使用这些你提供的依赖项。这也正是我们使用buildscript代码块的目的。</p>
<p>而如果你的项目中需要使用该类库的话，就需要定义在buildscript代码块之外的dependencies代码块中。所以有可能会看到在build.gradle中出现以下代码：</p>
<figure class="highlight groovy"><figcaption><span>build.gradle</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">repositories</span> {</div><div class="line">    mavenLocal()</div><div class="line">    mavenCentral()</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> {</div><div class="line">    <span class="keyword">compile</span> <span class="string">'org.springframework.ws:spring-ws-core:2.2.0.RELEASE'</span>,</div><div class="line">            <span class="string">'org.apache.commons:commons-csv:1.0'</span></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">buildscript</span> {</div><div class="line">    <span class="keyword">repositories</span> {</div><div class="line">        mavenLocal()</div><div class="line">        mavenCentral()</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">dependencies</span> {</div><div class="line">        <span class="keyword">classpath</span> <span class="string">'org.apache.commons:commons-csv:1.0'</span></div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.csv.*</div><div class="line"></div><div class="line"><span class="keyword">task</span> printCSV() {</div><div class="line">    <span class="keyword">doLast</span> {</div><div class="line">        <span class="keyword">def</span> records = CSVFormat.EXCEL.parse(<span class="keyword">new</span> FileReader(<span class="string">'config/sample.csv'</span>))</div><div class="line">        <span class="keyword">for</span> (item in records) {</div><div class="line">            <span class="keyword">print</span> item.get(<span class="number">0</span>) + <span class="string">' '</span></div><div class="line">            <span class="keyword">println</span> item.get(<span class="number">1</span>)</div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>官方具体解释请参见：<a href="http://chimera.labs.oreilly.com/books/1234000001741/ch04.html#_buildscript_dependencies" target="_blank" rel="external">http://chimera.labs.oreilly.com/books/1234000001741/ch04.html#_buildscript_dependencies</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Gradle/" class="post__tag__link">Gradle</a></li><li class="post__tag__item"><a href="/tags/Build/" class="post__tag__link">Build</a></li></ul><a href="/2014/10/30/build-script-in-gradle/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2015 Cloud & DevOps小组</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/2014/10/30/using-jaxb-in-gradle/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/2014/10/29/walking-on-cloud-creating-coreos-cluster-part-1/" class="page-menu__link icon-arrow-right"></a></li></menu></footer></body></html>